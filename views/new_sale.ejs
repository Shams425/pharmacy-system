<% include inc/view_header %>

<body>
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      <% include inc/view_sidebar %>
      <div class="layout-page">
        <!-- Top Navbar -->
        <% include inc/view_top_menu %>

        <div id="content-wrapper">
          <div class="container-xxl flex-grow-1 container-p-y">
            <!-- Page Heading -->
            <!-- <div class="row">
                    <div class="col-lg-12">
                        <h1 class="page-header text-center">
                            New Sales Entry
                        </h1>
                    </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-12">
                            <table class="table table-striped" id="mainTable">
                                <thead>
                                    <tr>
                                        <th>Batch ID</th>
                                        <th>Medicine Name</th>
                                        <th>Quantity</th>
                                        <th>Cost Price</th>
                                        <th>Sell Price</th>
                                        <th>Production Date</th>
                                        <th>Expire Date</th>
                                        <th>Supplier Name</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% batch.forEach(function(item){ %>
                                        <tr>
                                            <td>
                                                <%= item.Batch_ID %>
                                            </td>
                                            <td>
                                                <%= item.Medicine_Name %>
                                            </td>
                                            <td>
                                                <%= item.Quantity %>
                                            </td>
                                            <td>
                                                <%= item.Cost_Price %>
                                            </td>
                                            <td>
                                                <%= item.Sell_Price %>
                                            </td>
                                            <td>
                                                <%= item.Production_Date %>
                                            </td>
                                            <td>
                                                <%= item.Expire_Date %>
                                            </td>
                                            <td>
                                                <%= item.Supplier_Name %>
                                            </td>
                                        </tr>
                                        <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>



                    <div class="row">

                        <form action="" method="POST">
                            <div class="col-lg-5 col-lg-offset-3">
                                <div class="form-group">
                                    <label for="invoice_number">Invoice Number</label>
                                    <input type="text" class="form-control" id="invoice_number"
                                        name="invoice_number" placeholder="Invoice Name" required>

                                </div>
                                <div class="form-group">
                                    <label for="entry_date">Entry Date</label>
                                    <input type="text" class="form-control" name="entry_date"
                                        id="entry_date" onkeydown="return false" required>
                                </div>
                            </div>
                            <table class="table table-striped">
                                <tr>
                                    <th>Medicine Name</th>
                                    <th>Quantity</th>
                                    <th>Sell Price</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="text" id="getMedicineName" name="typeahead"
                                            class="typeahead tt-query form-control" autocomplete="off"
                                            spellcheck="false" placeholder="Enter Product Name" />
                                    </td>
                                    <td>
                                        <input type="number" min="0" id="getQuantity"
                                            class="form-control" />
                                    <td>
                                        <input type="number" min="0" id="getSellPrice"
                                            class="form-control" />
                                    </td>
                                    <td>
                                        <input type="text" id="getAmount" class="form-control" />
                                    </td>
                                    <td>
                                        <input type="button" id="btnAdd" value="Add to list"
                                            class="btn dark-blue" />
                                    </td>
                                </tr>
                            </table>
                        </form>

                    </div>

                    <div style=" background-color:#34495e; color:white; padding:10px;">
                        Purchase Items List
                    </div>
                    <div id="orderItems"
                        style="height:260px; overflow-y:scroll; border:1px solid #BFAEAE;">
                    </div>
                    <div class="align-right">
                        <br />
                        <button type="button" id="btnNext" class="btn dark-blue btn-block">
                            Proceed to Checkout
                        </button>
                    </div>
                    <br />
                    <br />

                    <div class="col-lg-5 col-lg-offset-3">

                        <div class="form-group">
                            <label for="totalAmount">Total Amount</label>
                            <input type="text" class="form-control" id="totalAmount" name="totalAmount"
                                placeholder="Total Amount" required>

                        </div>

                        <div class="form-group">
                            <label for="discount">Discount(%)</label>
                            <input type="text" class="form-control" id="discount" name="discount"
                                placeholder="Discount" required>

                        </div>

                        <div class="form-group">
                            <label for="discountAmount">Discount Amount</label>
                            <input type="text" class="form-control" id="discountAmount"
                                name="discountAmount" placeholder="Discount Amount" required>

                        </div>

                        <div class="form-group">
                            <label for="totalPayable">Total Payable</label>
                            <input type="text" class="form-control" id="totalPayable"
                                name="totalPayable" placeholder="Total Payable" required>

                        </div>

                        <div class="form-group">
                            <label for="paid">Paid</label>
                            <input type="text" class="form-control" id="paid" name="paid"
                                placeholder="Paid" required>

                        </div>

                        <div class="form-group">
                            <label for="return">Return</label>
                            <input type="text" class="form-control" id="return" name="return"
                                placeholder="Return" required>

                        </div>
                        <br />
                        <br />

                        <input type="submit" class="btn btn-success btn-block" name="submit"
                            value="Submit New Sell">
                    </div>   -->

            <form action="#" class="form col-12">
              <h1 class="text-center">New Sale</h1>
              <!-- Progress bar -->
              <div class="progressbar">
                <div class="progress" id="progress"></div>

                <div
                  class="progress-step progress-step-active"
                  data-title="Medicine"
                ></div>
                <div class="progress-step" data-title="info"></div>
              </div>

              <!-- Steps -->
              <div class="form-step form-step-active">
                <div class="formsInputs d-flex justify-content-between p-2 flex-wrap mb-3">
                  <div class="col-lg-6 col-md-6 col-sm-12 p-2 p-2">
                    <label for="username">Medicine Name</label>
                    <input class="form-control" type="text" name="medicineName" id="medicineName" />
                  </div>
                  <div class="col-lg-6 col-md-6 col-sm-12 p-2 p-2">
                    <label for="position">Medicine Type</label>
                    <select name="" id="" class="form-control" style="height: 49px;">
                      <option value="Tablets">Tablets</option>
                      <option value="Liquate">Liquate</option>
                      <option value="Injection">Injection</option>
                      <option value="Cream">Cream</option>
                      <option value="Baoder">Baoder</option>
                    </select>
                  </div>
                  <div class="col-lg-6 col-md-6 col-sm-12 p-2 p-2">
                    <label for="username">Company Region</label>
                    <input type="text" name="medicineName" id="medicineName" />
                  </div>
                  <div class="col-lg-6 col-md-6 col-sm-12 p-2 p-2">
                    <label for="position">Quantity</label>
                    <input type="number" name="position" id="position" />
                  </div>
                  <div class="col-lg-6 col-md-6 col-sm-12 p-2 p-2">
                    <label for="position">Price</label>
                    <input type="number" name="position" id="position" />
                  </div>
                </div>
                <div class="">
                  <a href="#" class="btn btn-primery btn-next width-50 ml-auto"
                    >Next</a
                  >
                </div>
              </div>
              <div class="form-step">
                <div class="input-group">
                  <h2 for="dob">Sale Info</h2>
                </div>
                <hr>
                <div class="saleInfo">
                  <div class="d-flex mb-3">
                    <p class="fw-bold">Name :</p>
                    <span>&nbsp; Bandol</span>
                  </div>
                  <div class="d-flex mb-3">
                    <p class="fw-bold">Type :</p>
                    <span>&nbsp; Tablets</span>
                  </div>
                  <div class="d-flex mb-3">
                    <p class="fw-bold">Quantity :</p>
                    <span>&nbsp; 1 Packet</span>
                  </div>
                  <div class="d-flex mb-3">
                    <p class="fw-bold">Price :</p>
                    <span>&nbsp; 1200 SDG</span>
                  </div>
                  
                </div>
                <div class="btns-group">
                  <a href="#" class="btn btn-prev">Previous</a>
                  <button class="btn" type="button">Submit</button>
                </div>
              </div>
            </form>
        </div>

        <hr />
        <script>
          const prevBtns = document.querySelectorAll(".btn-prev");
          const nextBtns = document.querySelectorAll(".btn-next");
          const progress = document.getElementById("progress");
          const formSteps = document.querySelectorAll(".form-step");
          const progressSteps = document.querySelectorAll(".progress-step");

          let formStepsNum = 0;

          nextBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
                formStepsNum++
                updateFormSteps()
                updateProgressbar()
            });
          });

          prevBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
                formStepsNum--;
                updateFormSteps();
                updateProgressbar();
            });
          });

          function updateFormSteps() {
            formSteps.forEach((formStep) => {
              formStep.classList.contains("form-step-active") &&
                formStep.classList.remove("form-step-active");
            });

            formSteps[formStepsNum].classList.add("form-step-active");
          }

          function updateProgressbar() {
            progressSteps.forEach((progressStep, idx) => {
              if (idx < formStepsNum + 1) {
                progressStep.classList.add("progress-step-active");
              } else {
                progressStep.classList.remove("progress-step-active");
              }
            });

            const progressActive = document.querySelectorAll(
              ".progress-step-active"
            );

            progress.style.width =
              ((progressActive.length - 1) / (progressSteps.length - 1)) *
                100 +
              "%";
          }
        </script>

        <!-- <script type="text/javascript">
              $(document).ready(function(){
                  $('input.typeahead').typeahead({
                      name: 'medicine',
                      remote: 'http://localhost:5000/search?key=%QUERY',
                      limit: 25
                  });
              });
          </script>

          <script>
              $("#getMedicineName").keyup(function () {
                  $.ajax({
                      url: "/admin/medicineSearch/",
                      data: $('#getMedicineName').val(),
                      success: function (result) {
                          $("#getMedicineName").val(result);
                      }
                  });
              });

              document.getElementById('mainTable').onclick = function (event) {
                  event = event || window.event;
                  const target = event.target || event.srcElement;
                  while (target && target.nodeName != 'TR') {
                      target = target.parentElement;
                  }
                  const cells = target.cells;
                  if (!cells.length || target.parentNode.nodeName == 'THEAD') {
                      return;
                  }
                  $(function () {
                      $('#getMedicineName').val($.trim(cells[1].innerHTML));
                      $('#getSellPrice').val($.trim(cells[4].innerHTML));
                  });
                  //clears quantity and amount field
                  $('#getQuantity').val('');
                  $('#getAmount').val('');
                  //focuses cursor on Qty field
                  document.getElementById('getQuantity').focus();
              }


              //Calculate Amount based on input Quantity
              $('#getQuantity').keyup(function () {
                  const available = Number($('#getAvailability').val());
                  const quantity = Number($('#getQuantity').val());
                  const sellPrice = Number($('#getSellPrice').val());
                  if (quantity > available) {
                      $('#getQuantity').val(available);
                      quantity = available;
                  }
                  const amount = (quantity * sellPrice).toFixed(2);
                  $('#getAmount').val(amount);
              });


              //Calculate Amount based on input Sell Price
              $('#getSellPrice').keyup(function () {
                  const available = Number($('#getAvailability').val());
                  const quantity = Number($('#getQuantity').val());
                  const sellPrice = Number($('#getSellPrice').val());
                  if (quantity > available) {
                      $('#getQuantity').val(available);
                      quantity = available;
                  }
                  const amount = (quantity * sellPrice).toFixed(2);
                  $('#getAmount').val(amount);
              });


              //Calculate Amount based on input Sell Price
              $('#getAmount').focus(function () {
                  const available = Number($('#getAvailability').val());
                  const quantity = Number($('#getQuantity').val());
                  const sellPrice = Number($('#getSellPrice').val());
                  if (quantity > available) {
                      $('#getQuantity').val(available);
                      quantity = available;
                  }
                  const amount = (quantity * sellPrice).toFixed(2);
                  $('#getAmount').val(amount);
              });



              const purchaseItems = [];
              //Adding items to sales items
              $('#btnAdd').on('click', function () {

                  if ($('#getQuantity').val() == '' || $('#getQuantity').val() == 0 || !$.isNumeric($(
                          '#getQuantity').val())) {
                      alert('Please Enter Quantity!');
                  }else if ($('#getSellPrice').val() == '' || $('#getSellPrice').val() == 0 || !$.isNumeric($(
                          '#getSellPrice').val())) {
                          alert('Please Enter Sell Price!');
                  }else if ($('#getMedicineName').val() == '' || $('#getMedicineName').val() == 0) {
                          alert('Please Enter Medicine Name!');
                  }else if ($('#getAmount').val() == '' || $('#getAmount').val() == 0 || !$.isNumeric($(
                          '#getAmount').val())) {
                          alert('Not A Valid Amount!');
                  }
                  else {
                      purchaseItems.push({
                          Medicine_Name: $('#getMedicineName').val(),
                          Quantity: $('#getQuantity').val(),
                          Cost: $('#getSellPrice').val(),
                          Amount: $('#getAmount').val()
                      });

                      if (purchaseItems.length > 0) {
                          const $table = $('<table class="table table-bordered" id="mytable" border="1" cellpadding="10"/>');
                          $table.append(
                              '<thead><tr><th>Medicine Name</th><th>Quantity</th><th>Rate</th><th>Amount</th></tr></thead>'
                          );
                          const $tbody = $('<tbody/>');

                          $.each(purchaseItems, function (i, val) {
                              const $row = $('<tr class="salesItemsRows"/>');
                              $row.append($('<td />').html(val.Medicine_Name));
                              $row.append($('<td class="tdQuantity"/>').html(val.Quantity));
                              $row.append($('<td class="tdSellPrice"/>').html(val.Cost));
                              $row.append($('<td/>').html(val.Amount));
                              $tbody.append($row);
                          });
                          $table.append($tbody);
                          $('#orderItems').html($table);

                          $(function () {
                              $clear = '';
                              $('#getMedicineName').val('');
                              $('#getQuantity').val('');
                              $('#getSellPrice').val('');
                              $('#getAmount').val('');
                          });
                      } else {
                          alert("List is empty !");
                      }
                  }

              });


              $('#btnNext').on('click', function () {

                  const isAllValid = true;

                  if (purchaseItems.length == 0) {
                      isAllValid = false;
                      alert('Please Add items to purchase!');
                  } else {
                      const subTotal = 0;
                      const total = 0;
                      $('#totalAmount').val('');
                      $('#discount').val('');
                      $('#totalPayable').val('');

                      $('#mytable tr').each(function () {
                          const quantity = $.trim($(this).find(".tdQuantity").html());
                          const sellPrice = $.trim($(this).find(".tdSellPrice").html());
                          total = Number(quantity) * Number(sellPrice);
                          subTotal += total;
                      });

                      $('#totalAmount').val(subTotal);
                      $('#totalPayable').val(subTotal);
                  }
              });


              //For calculating  Grand Total after the Discount Percentage
              $('#discount').keyup(function () {
                  const amount = Number($('#totalAmount').val());
                  const discount = Number($('#discount').val());

                  const discountAmount = (amount * discount) / 100;
                  const totalPayable = (amount - discountAmount).toFixed(2);
                  $('#discountAmount').val(discountAmount);
                  $('#totalPayable').val(totalPayable);

                  $('#paid').keyup(function () {

                      const paid = Number($('#paid').val());

                      const returned = (paid - totalPayable).toFixed(2);

                      $('#return').val(returned);
                  });
              });
          </script> -->
        <% include inc/view_footer.ejs %>

          
